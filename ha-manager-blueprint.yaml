tosca_definitions_version: cloudify_dsl_1_3

imports:
  - http://www.getcloudify.org/spec/cloudify/3.4.1/types.yaml
  - http://www.getcloudify.org/spec/fabric-plugin/1.4.1/plugin.yaml
  - types/manager-types.yaml
  - inputs/manager-inputs.yaml


plugins:
  cli:
    install: false
    executor: central_deployment_agent
  ha:
    install: false
    executor: central_deployment_agent

inputs:

  #############################
  # Provider specific Inputs
  #############################
  public_ip:
    type: string

  private_ip:
    type: string

  ssh_user:
    type: string

  ssh_port:
    type: string
    default: 22
    description: >
      Manager SSH port

  ssh_key_filename:
    type: string

  agents_user:
    default: ubuntu
    type: string

  resources_prefix:
    default: ''
    type: string

  manager_cluster_config: {}

  floating_ip:
    type: string

  consul_bootstrap:
    type: boolean
    default: true

  consul_join:
    default: ''

  #############################
  # Upload Resources Inputs
  #############################
  dsl_resources:
    description: >
      Holds a set of dsl required resources
    default:
      - {'source_path': 'http://www.getcloudify.org/spec/openstack-plugin/1.4/plugin.yaml', 'destination_path': '/spec/openstack-plugin/1.4/plugin.yaml'}
      - {'source_path': 'http://www.getcloudify.org/spec/aws-plugin/1.4.1/plugin.yaml', 'destination_path': '/spec/aws-plugin/1.4.1/plugin.yaml'}
      - {'source_path': 'http://www.getcloudify.org/spec/tosca-vcloud-plugin/1.3.1/plugin.yaml', 'destination_path': '/spec/tosca-vcloud-plugin/1.3.1/plugin.yaml'}
      - {'source_path': 'http://www.getcloudify.org/spec/vsphere-plugin/2.0/plugin.yaml', 'destination_path': '/spec/vsphere-plugin/2.0/plugin.yaml'}
      - {'source_path': 'http://www.getcloudify.org/spec/fabric-plugin/1.4.1/plugin.yaml', 'destination_path': '/spec/fabric-plugin/1.4.1/plugin.yaml'}
      - {'source_path': 'http://www.getcloudify.org/spec/diamond-plugin/1.3.4/plugin.yaml', 'destination_path': '/spec/diamond-plugin/1.3.4/plugin.yaml'}
      - {'source_path': 'http://www.getcloudify.org/spec/cloudify/3.4.1/types.yaml', 'destination_path': '/spec/cloudify/3.4.1/types.yaml'}

  #############################
  # Dev Inputs
  #############################

  # Some plugins installed from sources require compilation - installs a
  # compiler and the python headers to allow that.
  install_python_compilers:
    type: boolean
    default: false

  #############################
  # Telecom Edition
  #############################
  telecom_edition:
    description: >
      Set this to true if you want Telecom Edition
    type: boolean
    default: false

######################################################################
# This is a simple blueprint specific node_type to allow us to define
# The public_ip of the machine is an accessible property of the host.
# By default, the `ip` property is the private ip.
######################################################################
node_types:
  cloudify.nodes.ManagerHost:
    derived_from: cloudify.nodes.Compute
    properties:
      public_ip:
        type: string
        default: { get_input: public_ip }

  cloudify.nodes.Cluster:
    derived_from: cloudify.nodes.Root
    properties:
      cluster_config: {}
      consul_bootstrap:
        type: boolean
        default: { get_input: consul_bootstrap }
      consul_join:
        default: { get_input: consul_join }
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          ha.ha.tasks.prepare_cluster_configuration

  FloatingIP:
    derived_from: cloudify.nodes.Root
    properties:
      ip: {}

node_templates:
  # Cluster-wide nodes, not replicated
  floating_ip:
    type: FloatingIP
    properties:
      ip: { get_input: floating_ip }

  cluster_configuration:
    type: cloudify.nodes.Cluster
    properties:
      cluster_config: { get_input: manager_cluster_config }

  # Manager nodes, replicated
  manager_host_configuration:
    type: cloudify.nodes.Root
    relationships:
      - type: manager_host_config_from_cluster_config
        target: cluster_configuration

  manager_host:
    type: cloudify.nodes.ManagerHost
    properties:
      install_agent: false
    relationships:
      - type: manager_host_from_config
        target: manager_host_configuration

  keepalived:
    type: manager.nodes.Keepalived
    relationships:
      - type: cloudify.relationships.contained_in
        target: manager_host
      - type: keepalived_in_host
        target: manager_host_configuration
      - type: set_floating_ip
        target: floating_ip

  # #####################################################################
  # The manager_configuration node is meant to be read by Cloudify to
  # provide runtime configuration and information for the CLI and the
  # Manager.
  # #####################################################################
  manager_resources:
    type: cloudify.nodes.ManagerResources
    relationships:
      - type: cloudify.relationships.contained_in
        target: manager_host
      - type: cloudify.relationships.depends_on
        target: manager_configuration
      # XXX only for sequencing
      - type: cloudify.relationships.depends_on
        target: keepalived

  manager_configuration:
    type: cloudify.nodes.MyCloudifyManager
    properties:
      ssh_user: { get_input: ssh_user }
      ssh_port: { get_input: ssh_port }
      ssh_key_filename: { get_input: ssh_key_filename }
      cloudify:
        resources_prefix: { get_input: resources_prefix }

        cloudify_agent:
          min_workers: 0
          max_workers: 5
          remote_execution_port: 22
          user: { get_input: agents_user }
          broker_ip: { get_input: rabbitmq_endpoint_ip }
          broker_user: { get_input: rabbitmq_username }
          broker_pass: { get_input: rabbitmq_password }
          broker_ssl_enabled: { get_input: rabbitmq_ssl_enabled }
          broker_ssl_cert: { get_input: rabbitmq_cert_public }
          verify_rest_certificate: { get_input: agent_verify_rest_certificate }

        workflows:
          task_retries: -1  # this means forever
          task_retry_interval: 30

        policy_engine:
          start_timeout: 30

        # Declare rules for the default import resolver
        # which enables using the manager in offline mode.
        # The resolver replaces an import's http link with the local path
        # on the manager according to the matching rule's value.
        # If the resolver cannot read the import from the specified local path
        # (e.g. when the manager is not in offline mode),
        # it will fall back to the original http link.
        import_resolver:
          parameters:
            rules:
            - {'http://www.getcloudify.org/spec': 'file:///opt/manager/resources/spec'}

        upload_resources:
          dsl_resources: { get_input: dsl_resources }

    interfaces:
      cloudify.interfaces.lifecycle:
        configure:
          implementation: fabric.fabric_plugin.tasks.run_script
          inputs:
            script_path: components/manager/scripts/configure_manager.py
            hide_output: &hide_output
              - running
            fabric_env: { get_attribute: [manager_host_configuration, fabric_env] }

    relationships:
      - type: set_floating_ip
        target: floating_ip
      - type: cloudify.relationships.contained_in
        target: manager_host
        target_interfaces:
          cloudify.interfaces.relationship_lifecycle:
            postconfigure:
              implementation: components/manager/scripts/set_manager_ips.py
              inputs:
                public_ip: { get_property: [floating_ip, ip] }
                rest_host_internal_endpoint_type: { get_property: [rest_service, rest_host_internal_endpoint_type] }
                rest_host_external_endpoint_type: { get_property: [rest_service, rest_host_external_endpoint_type] }

  python_runtime:
    type: manager.nodes.PythonRuntime
    relationships:
      - type: cloudify.relationships.contained_in
        target: manager_host
      - type: cloudify.relationships.depends_on
        target: manager_configuration
      - type: cloudify.relationships.depends_on
        target: manager_resources

  java_runtime:
    type: manager.nodes.JavaRuntime
    relationships:
      - type: cloudify.relationships.contained_in
        target: manager_host
      - type: cloudify.relationships.depends_on
        target: manager_configuration
      - type: cloudify.relationships.depends_on
        target: manager_resources

  consul:
    type: manager.nodes.Consul
    relationships:
      - type: cloudify.relationships.contained_in
        target: manager_host
      - type: consul_in_cluster
        target: cluster_configuration

  confd:
    type: manager.nodes.Confd
    relationships:
      - type: cloudify.relationships.contained_in
        target: manager_host
      - type: cloudify.relationships.depends_on
        target: consul

  rabbitmq:
    type: manager.nodes.RabbitMQ
    relationships:
      - type: cloudify.relationships.contained_in
        target: manager_host
      - type: cloudify.relationships.depends_on
        target: manager_configuration
      - type: cloudify.relationships.depends_on
        target: manager_resources

  postgresql:
    type: manager.nodes.Postgresql
    relationships:
      - type: cloudify.relationships.contained_in
        target: manager_host
      - type: cloudify.relationships.depends_on
        target: consul
      - type: cloudify.relationships.depends_on
        target: python_runtime

  elasticsearch:
    type: manager.nodes.Elasticsearch
    relationships:
      - type: cloudify.relationships.contained_in
        target: manager_host
      - type: cloudify.relationships.depends_on
        target: manager_configuration
      - type: cloudify.relationships.depends_on
        target: manager_resources
      - type: cloudify.relationships.depends_on
        target: java_runtime
      - type: elasticsearch_to_manager_configuration
        target: manager_configuration

  syncthing:
    type: manager.nodes.Syncthing
    relationships:
      - type: cloudify.relationships.contained_in
        target: manager_host
      - type: cloudify.relationships.depends_on
        target: consul
      - type: cloudify.relationships.depends_on
        target: confd

  rest_service:
    type: manager.nodes.RestService
    relationships:
      - type: cloudify.relationships.contained_in
        target: manager_host
      - type: cloudify.relationships.depends_on
        target: manager_resources
      - type: cloudify.relationships.depends_on
        target: python_runtime
      - type: rest_to_manager_configuration
        target: manager_configuration
      - type: restservice_to_elasticsearch
        target: elasticsearch
      - type: restservice_to_rabbitmq
        target: rabbitmq
      - type: cloudify.relationships.depends_on
        target: postgresql

  nginx:
    type: manager.nodes.Nginx
    relationships:
      - type: cloudify.relationships.contained_in
        target: manager_host
      - type: cloudify.relationships.depends_on
        target: manager_resources
      - type: cloudify.relationships.depends_on
        target: rest_service
      - type: nginx_to_manager_configuration
        target: manager_configuration

  mgmt_worker:
    type: manager.nodes.ManagementWorker
    relationships:
      - type: cloudify.relationships.contained_in
        target: manager_host
      - type: cloudify.relationships.depends_on
        target: manager_resources
      - type: cloudify.relationships.depends_on
        target: python_runtime
      - type: cloudify.relationships.depends_on
        target: nginx
      - type: mgmtworker_to_rabbitmq
        target: rabbitmq
      - type: mgmtworker_to_manager_configuration
        target: manager_configuration


relationships:
  consul_in_cluster:
    derived_from: cloudify.relationships.depends_on
    source_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        preconfigure:
          implementation:
            ha.ha.tasks.consul_in_cluster

  manager_host_from_config:
    derived_from: cloudify.relationships.contained_in
    source_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        preconfigure:
          implementation: ha.ha.tasks.manager_host_from_config

  set_floating_ip:
    derived_from: cloudify.relationships.connected_to
    source_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        preconfigure: ha.ha.tasks.set_floating_ip

  keepalived_in_host:
    derived_from: cloudify.relationships.connected_to
    source_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        preconfigure:
          implementation: ha.ha.tasks.keepalived_config_from_host

groups:
  cloudify_manager:
    members:
      - manager_host_configuration
      - manager_host
      - keepalived
      - manager_resources
      - manager_configuration
      - python_runtime
      - java_runtime
      - consul
      - confd
      - rabbitmq
      - postgresql
      - elasticsearch
      - rest_service
      - syncthing
      - nginx
      - mgmt_worker

policies:
  scale_policy1:
    type: cloudify.policies.scaling
    properties:
      default_instances: 1
    targets: [cloudify_manager]

outputs:
  manager_ip:
    value: { get_input: floating_ip }
  rest_server_public_certificate:
    value: ''
  private_ip:
    value: ''
